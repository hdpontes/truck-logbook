// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  login     String   @unique
  email     String   @unique
  password  String
  name      String
  cpf       String?  @unique
  phone     String?
  role      UserRole @default(DRIVER)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trips Trip[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  DRIVER
}

enum TruckStatus {
  GARAGE      // Parado na garagem
  IN_TRANSIT  // Em viagem
  MAINTENANCE // Em manutenção
}

model Truck {
  id          String      @id @default(uuid())
  plate       String      @unique
  model       String
  brand       String
  year        Int
  color       String?
  chassisNum  String?     @unique
  capacity    Float?      // Capacidade em toneladas
  avgConsumption Float?   @default(0) // Consumo médio km/l
  currentMileage Float?   @default(0) // Quilometragem atual do caminhão
  status      TruckStatus @default(GARAGE)
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  trips       Trip[]
  expenses    Expense[]
  maintenances Maintenance[]

  @@map("trucks")
}

model Trailer {
  id          String   @id @default(uuid())
  plate       String   @unique
  model       String?
  brand       String?
  year        Int?
  capacity    Float?   // Capacidade em toneladas
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trips       Trip[]

  @@map("trailers")
}

model Trip {
  id           String    @id @default(uuid())
  truckId      String
  truck        Truck     @relation(fields: [truckId], references: [id])
  trailerId    String?
  trailer      Trailer?  @relation(fields: [trailerId], references: [id])
  driverId     String
  driver       User      @relation(fields: [driverId], references: [id])
  
  tripCode     String?   // Código do pedido fornecido pelo cliente
  origin       String
  destination  String
  startDate    DateTime
  endDate      DateTime?
  distance     Float     @default(0) // em KM
  startMileage Float?    // Quilometragem inicial do caminhão
  endMileage   Float?    // Quilometragem final do caminhão
  
  // Financeiro
  revenue      Float     @default(0)
  fuelCost     Float     @default(0)
  tollCost     Float     @default(0)
  otherCosts   Float     @default(0)
  totalCost    Float     @default(0)
  profit       Float     @default(0)
  profitMargin Float     @default(0) // Percentual
  
  // Status
  status       TripStatus @default(PLANNED)
  
  // Observações
  notes        String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  expenses     Expense[]

  @@index([truckId])
  @@index([trailerId])
  @@index([driverId])
  @@index([status])
  @@index([startDate])
  @@map("trips")
}

enum TripStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DELAYED // Em atraso
}

model Expense {
  id          String      @id @default(uuid())
  truckId     String?
  truck       Truck?      @relation(fields: [truckId], references: [id])
  tripId      String?
  trip        Trip?       @relation(fields: [tripId], references: [id])
  
  type        ExpenseType
  category    String? // Subcategoria personalizada
  amount      Float
  quantity    Float?  // Ex: litros de combustível
  unitPrice   Float?
  
  description String?
  receipt     String? // URL da imagem do recibo
  invoiceNum  String? // Número da nota fiscal
  
  supplier    String? // Nome do fornecedor
  location    String? // Local da despesa
  
  date        DateTime
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([truckId])
  @@index([tripId])
  @@index([type])
  @@index([date])
  @@map("expenses")
}

enum ExpenseType {
  FUEL // Combustível
  TOLL // Pedágio
  MAINTENANCE // Manutenção
  TIRE // Pneus
  FOOD // Alimentação
  PARKING // Estacionamento
  INSURANCE // Seguro
  TAX // Impostos
  SALARY // Salário do motorista
  OTHER // Outros
}

model Maintenance {
  id          String          @id @default(uuid())
  truckId     String
  truck       Truck           @relation(fields: [truckId], references: [id])
  
  type        MaintenanceType
  description String
  cost        Float           @default(0)
  mileage     Float? // KM rodados no momento da manutenção
  scheduledMileage Float? // KM programada para manutenção preventiva
  
  scheduledDate DateTime?
  completedDate DateTime?
  
  supplier    String? // Oficina/fornecedor
  invoice     String? // Número da nota
  receipt     String? // URL do recibo
  
  status      MaintenanceStatus @default(PENDING)
  priority    Priority          @default(MEDIUM)
  
  notes       String?
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([truckId])
  @@index([status])
  @@index([scheduledDate])
  @@map("maintenances")
}

enum MaintenanceType {
  PREVENTIVE // Preventiva
  CORRECTIVE // Corretiva
  INSPECTION // Inspeção
  OIL_CHANGE // Troca de óleo
  TIRE_CHANGE // Troca de pneus
  BRAKE // Freios
  ENGINE // Motor
  TRANSMISSION // Transmissão
  ELECTRICAL // Elétrica
  OTHER // Outros
}

enum MaintenanceStatus {
  PENDING // Pendente
  SCHEDULED // Agendada
  IN_PROGRESS // Em andamento
  COMPLETED // Concluída
  CANCELLED // Cancelada
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Alert {
  id          String      @id @default(uuid())
  type        AlertType
  title       String
  message     String
  severity    Severity
  
  entityType  String? // truck, trip, maintenance
  entityId    String?
  
  read        Boolean     @default(false)
  readAt      DateTime?
  
  createdAt   DateTime    @default(now())

  @@index([read])
  @@index([createdAt])
  @@map("alerts")
}

enum AlertType {
  MAINTENANCE_DUE // Manutenção vencida
  HIGH_COST // Custo elevado
  LOW_PROFIT // Lucro baixo
  DOCUMENT_EXPIRING // Documento vencendo
  TRIP_DELAYED // Viagem atrasada
  FUEL_PRICE // Preço de combustível
  OTHER
}

enum Severity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model Client {
  id        String   @id @default(uuid())
  name      String
  cnpj      String   @unique
  address   String
  city      String
  state     String
  phone     String?
  email     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("clients")
}

model Location {
  id        String       @id @default(uuid())
  name      String
  city      String
  state     String
  type      LocationType @default(BOTH)
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("locations")
}

enum LocationType {
  ORIGIN
  DESTINATION
  BOTH
}

model Settings {
  id             String   @id @default(uuid())
  companyName    String   @default("Truck Logbook")
  companyLogo    String?  // URL do logo
  dieselPrice    Float    @default(0) // Preço por litro do diesel
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("settings")
}
